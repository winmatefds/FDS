/*
	$Workfile:   Dither.c  $
	$Revision: 1.8 $
	$Date: 2011/12/13 10:32:43 $
*/

//******************************************************************************
// COPYRIGHT (C) STMicroelectronics 2011.
//
// All rights reserved. This document contains proprietary and
// confidential information of the STMicroelectronics Group. This
// document is not to be copied in whole or part. STMicroelectronics
// assumes no responsibility for the consequences of use of such
// information nor for any infringement of patents or other rights of
// third parties which may result from its use. No license is granted by
// implication or otherwise under any patent or patent rights of
// STMicroelectronics.
// STMicroelectronics
// products are not authorized for use as critical components in life
// support devices or systems without express written approval of
// STMicroelectronics.
//******************************************************************************

//==============================================================================
//
// MODULE:      Dither.c
//
//******************************************************************************

//******************************************************************************
//  I N C L U D E    F I L E S
//******************************************************************************
#include "System\all.h"


#if (FEATURE_DITHER == ENABLE)

//******************************************************************************
//  D E F I N E S
//******************************************************************************

#define DEBUG_MSG 0 // 1
#define _DEBUG

#if(defined _DEBUG)&& DEBUG_MSG
#define msg(a,b)            gm_Print(a,b)
#define msg_dit(a,b)        msg("DITHER: " a, b)
#else
#define msg(a,b)
#define msg_dit(a,b)
#endif

#define DITHER_INPUT_DEPTH        14 // 10
#define DITHER_MIN_PANEL_DEPTH    6

#define DITHER_0BITS    0
#define DITHER_2BITS    1
#define DITHER_3BITS    2
#define DITHER_4BITS    3

//******************************************************************************
//  G L O B A L    V A R I A B L E S
//******************************************************************************
BYTE ROM Dither2bit[] =
{
   0x02, 0x7E, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE, 0x80, 0xFD, 0xF8, 0xC1, 0xFC, 0x81, 0x00, 0xFF,
   0x00, 0xFE, 0x02, 0x7E, 0x00, 0xFE, 0x00, 0xFE, 0xF0, 0xE1, 0xE0, 0xF1, 0xE0, 0xF1, 0xFC, 0x81,
   0xFC, 0x81, 0x80, 0xFD, 0x00, 0xFF, 0xF0, 0xE1, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE,
   0xC0, 0xF9, 0xFC, 0x81, 0xF8, 0xC1, 0xC0, 0xF9, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE,
   0x00, 0xFE, 0xE0, 0xF1, 0x00, 0xFE, 0x00, 0xFE, 0xFC, 0x81, 0x00, 0xFE, 0xE0, 0xF1, 0xF8, 0xC1,
   0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE, 0x80, 0xFD, 0xFC, 0x81, 0xF0, 0xE1, 0x00, 0xFF,
   0xF8, 0xC1, 0x00, 0xFE, 0xC0, 0xF9, 0xFC, 0x81, 0x00, 0xFE, 0xC2, 0x79, 0x00, 0xFE, 0x00, 0xFE,
   0x80, 0xFD, 0xF0, 0xE1, 0xFC, 0x81, 0x00, 0xFF, 0x02, 0x7E, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE,
   0x05, 0x00, 0x00, 0x00, 0x94, 0x00, 0x82, 0x00, 0x01, 0x00, 0x00, 0x00, 0x59, 0x06, 0x0F, 0x00,
   0x59, 0x06, 0x0F, 0x00, 0x59, 0x06, 0x0F, 0x00, 0x66, 0x00, 0x66, 0x00, 0x78, 0x78, 0x78, 0x78,
   0x78, 0x78, 0x0A, 0x00, 0x0A, 0x00, 0xAA, 0x00, 0xAA, 0x00, 0xAA, 0x00, 0xAA, 0xAA, 0xAA, 0xAA,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

BYTE ROM Dither4bit[] =
{
   0x02, 0x7E, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE, 0x80, 0xFD, 0xF8, 0xC1, 0xFC, 0x81, 0x00, 0xFF,
   0x00, 0xFE, 0x02, 0x7E, 0x00, 0xFE, 0x00, 0xFE, 0xF0, 0xE1, 0xE0, 0xF1, 0xE0, 0xF1, 0xFC, 0x81,
   0xFC, 0x81, 0x80, 0xFD, 0x00, 0xFF, 0xF0, 0xE1, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE,
   0xC0, 0xF9, 0xFC, 0x81, 0xF8, 0xC1, 0xC0, 0xF9, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE,
   0x00, 0xFE, 0xE0, 0xF1, 0x00, 0xFE, 0x00, 0xFE, 0xFC, 0x81, 0x00, 0xFE, 0xE0, 0xF1, 0xF8, 0xC1,
   0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE, 0x80, 0xFD, 0xFC, 0x81, 0xF0, 0xE1, 0x00, 0xFF,
   0xF8, 0xC1, 0x00, 0xFE, 0xC0, 0xF9, 0xFC, 0x81, 0x00, 0xFE, 0xC2, 0x79, 0x00, 0xFE, 0x00, 0xFE,
   0x80, 0xFD, 0xF0, 0xE1, 0xFC, 0x81, 0x00, 0xFF, 0x02, 0x7E, 0x00, 0xFE, 0x00, 0xFE, 0x00, 0xFE,
   0x05, 0x00, 0x00, 0x00, 0x94, 0x00, 0x82, 0x00, 0x01, 0x00, 0x00, 0x00, 0x59, 0x06, 0x0F, 0x00,
   0x59, 0x06, 0x0F, 0x00, 0x59, 0x06, 0x0F, 0x00, 0x66, 0x00, 0x66, 0x00, 0x78, 0x78, 0x78, 0x78,
   0x78, 0x78, 0x0A, 0x00, 0x0A, 0x00, 0xAA, 0x00, 0xAA, 0x00, 0xAA, 0x00, 0xAA, 0xAA, 0xAA, 0xAA,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
   0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};





//*****************************************************************************
// FUNCTION     : void Dither_UploadDitherTable(void)
// USAGE        : Uploades necessary table for dither
// INPUT        : none
// OUTPUT       :
// GLOBALS      :
// USED_REGS    :
//*****************************************************************************
void Dither_UploadDitherTable(void)
{
   BYTE ROM *   pMemAddr;
   BYTE    bSize = 128;
   BYTE    bStartAddr = 0;
   BYTE    bDitherCtrl = 0;

#if 0
   if (gm_ReadRegByte(DISP_LUT_CTRL) & LUT_CTRL)
   {
      msg_dit("Gamma is enabled. Return.", 0);
      return;
   }
#endif

#if 1
   pMemAddr = (BYTE ROM *)Dither4bit;
   bDitherCtrl |= (DITHER_4BITS << POST_LUT_DITHER_SEL_SHIFT);
   msg_dit("Always Dither 4 bit",0);
#else
   switch (abs(DITHER_INPUT_DEPTH-PanelDepth))
   {
      case 2:
         {
            pMemAddr = (BYTE ROM *)Dither2bit;
            bDitherCtrl |= (DITHER_2BITS << POST_LUT_DITHER_SEL_SHIFT);
            msg_dit("Dither2bit",0);
         }
         break;

      case 4:
         {
            pMemAddr = (BYTE ROM *)Dither4bit;
            bDitherCtrl |= (DITHER_4BITS << POST_LUT_DITHER_SEL_SHIFT);
            msg_dit("Dither4bit",0);
         }
         break;

      default:
         {
            msg_dit("Panel Depth invalid: %d", PanelDepth);
            return;
         }
   }
#endif

   bDitherCtrl |= (PanelDepth-DITHER_MIN_PANEL_DEPTH)/2;

   for (; bSize; bSize--)
   {
      gm_WriteRegByte(DISP_DITHER_TABLE_INDEX, bStartAddr);
      msg_dit("Index: %x", bStartAddr);
      bStartAddr++;
      //gm_WriteRegByte(DISP_DITHER_TABLE_DATA_LO, pMemAddr[0]);
      //gm_WriteRegByte(DISP_DITHER_TABLE_DATA_HI, pMemAddr[1]);
      gm_WriteRegWord(DISP_DITHER_TABLE_DATA, (WORD)pMemAddr[0]|(pMemAddr[1]<<8));
      msg_dit("Lo: %x", pMemAddr[0]);
      msg_dit("Hi: %x", pMemAddr[1]);
      pMemAddr += sizeof(WORD);
   }

   //bDitherCtrl |= POST_LUT_DITH_EN;
   gm_SetRegBitsWord(DITHER_OUTPUT_CTRL, POST_LUT_DITH_EN);

   gm_WriteRegByte(POST_LUT_DITHER_CTRL, bDitherCtrl);

#if (defined _DEBUG) && DEBUG_MSG
   if (gm_ReadRegByte(POST_LUT_DITHER_CTRL) != bDitherCtrl)
   {
      msg_dit("Cannot write 0x%x to POST_LUT_DITHER_CTRL", bDitherCtrl);
      msg_dit("POST_LUT_DITHER_CTRL is 0x%x", gm_ReadRegByte(POST_LUT_DITHER_CTRL));
   }
   else
      msg_dit("%d bits dither table is loaded", abs(DITHER_INPUT_DEPTH-PanelDepth));
#endif

   msg_dit("Finish Dither_UploadDitherTable", 0);
}

#endif
